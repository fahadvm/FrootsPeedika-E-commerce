<%- include('../partials/user/header') %>


    <style>
        :root {
            --primary: #F28123;
            --secondary: #051922;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --text-dark: #333;
            --text-muted: #777;
            --success: #28a745;
            --danger: #dc3545;
            --border: #eeeeee;
        }

        .product-page-wrapper {
            background-color: var(--light-bg);
            padding: 80px 0;
            min-height: 100vh;
        }

        .product-card-main {
            background: var(--white);
            border-radius: 20px;
            /* overflow: hidden removed to allow zoom projection */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
            position: relative;
        }

        .product-gallery-side {
            flex: 1;
            min-width: 400px;
            padding: 40px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main-image-container {
            width: 100%;
            height: 450px;
            border-radius: 15px;
            /* overflow: hidden removed to allow zoom lens/result projection */
            background: #fdfdfd;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: crosshair;
        }

        .main-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        /* Flipkart-style Zoom CSS */
        .zoom-lens {
            position: absolute;
            border: 1px solid rgba(242, 129, 35, 0.5);
            width: 150px;
            height: 150px;
            background-color: rgba(242, 129, 35, 0.1);
            cursor: crosshair;
            display: none;
            z-index: 100;
        }

        .zoom-result {
            position: absolute;
            left: calc(100% + 20px);
            /* Positioned 20px to the right of the gallery */
            top: 0;
            width: 500px;
            height: 500px;
            border: 1px solid #d4d4d4;
            background-repeat: no-repeat;
            display: none;
            z-index: 9999;
            /* Extremely high to stay on top */
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            pointer-events: none;
        }

        @media (max-width: 991px) {
            .zoom-result {
                display: none !important;
                /* Disable side zoom on mobile */
            }

            .zoom-lens {
                display: none !important;
            }
        }

        .thumbnails-container {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .thumbnail-box {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            border: 2px solid transparent;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--white);
            padding: 5px;
        }

        .thumbnail-box.active {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(242, 129, 35, 0.2);
        }

        .thumbnail-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .product-details-side {
            flex: 1;
            min-width: 400px;
            padding: 50px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .product-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-organic {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-premium {
            background: #fff8e1;
            color: #ffa000;
        }

        .product-title-main {
            font-size: 2.8rem;
            color: var(--secondary);
            font-weight: 800;
            margin: 0;
            line-height: 1.2;
        }

        .rating-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stars {
            color: #ffc107;
            font-size: 1.1rem;
        }

        .review-count {
            color: var(--text-muted);
            font-size: 14px;
        }

        .pricing-box {
            display: flex;
            align-items: baseline;
            gap: 15px;
            margin-top: 10px;
        }

        .price-sale {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .price-regular {
            font-size: 1.4rem;
            color: var(--text-muted);
            text-decoration: line-through;
        }

        .offer-tag {
            background: var(--danger);
            color: white;
            padding: 2px 10px;
            border-radius: 5px;
            font-weight: 700;
            font-size: 14px;
        }

        .description-text {
            color: #555;
            line-height: 1.7;
            font-size: 1.05rem;
        }

        .nutritional-info {
            background: #fafafa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--primary);
        }

        .nutritional-info h5 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--secondary);
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .stock-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-add-cart {
            flex: 2;
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }

        .btn-add-cart:hover {
            background: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-wishlist {
            flex: 1;
            background: var(--white);
            color: var(--secondary);
            border: 2px solid var(--secondary);
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-wishlist:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-wishlist.in-wishlist {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-wishlist.in-wishlist:hover {
            background: #b52b3a;
            border-color: #b52b3a;
        }

        .reviews-section {
            margin-top: 40px;
            border-top: 2px dashed var(--border);
            padding-top: 30px;
        }

        .review-item {
            background: #fdfdfd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .reviewer-name {
            font-weight: 700;
            color: var(--secondary);
        }

        .review-text {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        @media (max-width: 991px) {

            .product-gallery-side,
            .product-details-side {
                flex: none;
                width: 100%;
            }
        }
    </style>

    <div class="breadcrumb-section breadcrumb-bg">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-2 text-center">
                    <div class="breadcrumb-text">
                        <p>Fresh & Organic</p>
                        <h1>Product Details</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="product-page-wrapper">
        <div class="container">
            <div class="product-card-main">
                <!-- Left Side: Image Gallery -->
                <div class="product-gallery-side" style="position: relative; z-index: 10;">
                    <div class="main-image-container" id="mainImageArea">
                        <div id="zoomLens" class="zoom-lens"></div>
                        <img id="main-img" src="<%= product.productImages[0] %>" alt="<%= product.productName %>">
                    </div>
                    <div id="zoomResult" class="zoom-result"></div>
                    <div class="thumbnails-container">
                        <% product.productImages.forEach((img, index)=> { %>
                            <div class="thumbnail-box <%= index === 0 ? 'active' : '' %>"
                                onclick="updateMainImg('<%= img %>', this)">
                                <img src="<%= img %>" alt="Thumbnail">
                            </div>
                            <% }); %>
                    </div>
                </div>

                <!-- Right Side: Content -->
                <div class="product-details-side">
                    <div class="product-info-top">
                        <span class="product-badge badge-organic">
                            <% if (product.organic==='yes' ) { %>
                                100% Organic
                                <% } else { %>
                                    NON-Organic
                                    <% } %>
                        </span>
                        <span class="product-badge badge-premium">
                            <% if (product.freshFroze==='frozen' ) { %>
                                frozen
                                <% } else { %>
                                    FRESH
                                    <% } %>
                        </span>

                    </div>

                    <h1 class="product-title-main">
                        <%= product.productName %>
                    </h1>

                    <!-- <div class="rating-summary">
                        <div class="stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="review-count">(4.5/5 Rating based on 124 reviews)</span>
                    </div> -->

                    <div class="pricing-box">
                        <span class="price-sale">₹<%= product.salePrice %></span>
                        <% if (product.regularPrice> product.salePrice) { %>
                            <span class="price-regular">₹<%= product.regularPrice %></span>
                            <span class="offer-tag">
                                <%= Math.round(((product.regularPrice - product.salePrice)/product.regularPrice)*100) %>
                                    % OFF
                            </span>
                            <% } %>
                    </div>

                    <p class="description-text">
                        <%= product.shortDescription %>
                    </p>

                    <div class="nutritional-info">
                        <h5>Nutritional Information</h5>
                        <p class="mb-0">
                            <%= product.nutritionalInfo %>
                        </p>
                    </div>

                    <div class="stock-info">
                        <% if (product.stock> 0) { %>
                            <div class="stock-dot" style="background: var(--success);"></div>
                            <span style="color: var(--success);">In Stock</span>
                            <span class="text-muted">(<%= product.stock %> available)</span>
                            <% } else { %>
                                <div class="stock-dot" style="background: var(--danger);"></div>
                                <span style="color: var(--danger);">Out of Stock</span>
                                <% } %>
                    </div>

                    <div class="action-buttons">
                        <% if (locals.isInCart) { %>
                            <button class="btn-add-cart" onclick="window.location.href='/cart'">
                                <i class="fas fa-shopping-cart"></i> Go to Cart
                            </button>
                            <% } else { %>
                                <button class="btn-add-cart" onclick="addToCart('<%= product._id %>')" <%=product.stock
                                    <=0 ? 'disabled' : '' %>>
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                                <% } %>
                                    <% let isInWishlist=false; if (user && user.wishlist) {
                                        isInWishlist=user.wishlist.some(id=>
                                        id.toString() === product._id.toString());
                                        }
                                        %>
                                        <button id="wishlistBtn"
                                            class="btn-wishlist <%= isInWishlist ? 'in-wishlist' : '' %>"
                                            onclick="addToWishlist('<%= product._id %>')">
                                            <i class="<%= isInWishlist ? 'fas' : 'far' %> fa-heart"></i>
                                        </button>
                    </div>


                </div>
            </div>
        </div>
    </div>
    </div>
    <section class="related-product-area section_gap_bottom mt-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6 text-center">
                    <div class="section-title">
                        <h1>Related Products</h1>
                        <p>Explore our range of related products that complement your purchase. Each item is carefully
                            selected to ensure the highest quality and satisfaction.</p>
                    </div>
                </div>
            </div>
            <div class="row">
                <% for(let i=0; i < 8 && i < products.length; i++) { %>
                    <div class="col-lg-3 col-md-4 text-center">
                        <div class="single-product-item">
                            <div class="product-image">
                                <a href="/productDetails?id=<%= products[i]._id.toString() %>">
                                    <img src="<%= products[i].productImages[0] %>" alt="<%= products[i].productName %>">
                                </a>
                            </div>
                            <h3>
                                <%= products[i].productName %>
                            </h3>
                            <p class="product-price">
                                <span>Per Kg</span>₹ <%= products[i].salePrice %>
                            </p>
                            <a href="/productDetails?id=<%= products[i]._id.toString() %>" class="cart-btn">
                                <i class="fas fa-shopping-cart"></i> View Details
                            </a>
                        </div>
                    </div>
                    <% } %>
            </div>

    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // GSAP Entrance Animations
            gsap.from(".product-card-main", {
                duration: 1,
                y: 50,
                opacity: 0,
                ease: "power4.out"
            });

            gsap.from(".product-gallery-side", {
                duration: 1.2,
                x: -30,
                opacity: 0,
                delay: 0.2,
                ease: "power3.out"
            });

            gsap.from(".product-details-side > *", {
                duration: 0.8,
                y: 20,
                opacity: 0,
                stagger: 0.1,
                delay: 0.4,
                ease: "power2.out"
            });
        });

        // Flipkart-style Zoom Logic
        function initZoom() {
            const img = document.getElementById("main-img");
            const lens = document.getElementById("zoomLens");
            const result = document.getElementById("zoomResult");
            const container = document.getElementById("mainImageArea");

            if (!img || !lens || !result || !container) return;

            container.addEventListener("mouseenter", () => {
                if (window.innerWidth > 991) {
                    lens.style.display = "block";
                    result.style.display = "block";
                    // Using current set source
                    result.style.backgroundImage = `url('${img.src}')`;
                }
            });

            container.addEventListener("mouseleave", () => {
                lens.style.display = "none";
                result.style.display = "none";
            });

            container.addEventListener("mousemove", (e) => {
                if (window.innerWidth <= 991) return;

                const rect = container.getBoundingClientRect();

                // Calculate lens position
                let x = e.clientX - rect.left - (lens.offsetWidth / 2);
                let y = e.clientY - rect.top - (lens.offsetHeight / 2);

                // Boundaries
                if (x > rect.width - lens.offsetWidth) x = rect.width - lens.offsetWidth;
                if (x < 0) x = 0;
                if (y > rect.height - lens.offsetHeight) y = rect.height - lens.offsetHeight;
                if (y < 0) y = 0;

                lens.style.left = x + "px";
                lens.style.top = y + "px";

                // Magnification ratios
                const cx = result.offsetWidth / lens.offsetWidth;
                const cy = result.offsetHeight / lens.offsetHeight;

                // Adjust background for 'object-fit: contain' centering
                // The image is centered in a 450px height container
                const imgWidth = img.clientWidth;
                const imgHeight = img.clientHeight;
                const imgLeft = img.offsetLeft;
                const imgTop = img.offsetTop;

                result.style.backgroundSize = (imgWidth * cx) + "px " + (imgHeight * cy) + "px";

                let bgX = (x - imgLeft) * cx;
                let bgY = (y - imgTop) * cy;

                result.style.backgroundPosition = `-${bgX}px -${bgY}px`;
            });
        }

        initZoom();

        // Update zoom when image changes
        function updateMainImg(newSrc, element) {
            const mainImg = document.getElementById('main-img');
            mainImg.src = newSrc;

            // Sync with zoom
            const result = document.getElementById("zoomResult");
            result.style.backgroundImage = `url('${newSrc}')`;

            document.querySelectorAll('.thumbnail-box').forEach(box => box.classList.remove('active'));
            element.classList.add('active');

            gsap.from("#main-img", {
                duration: 0.5,
                opacity: 0.5,
                scale: 0.95,
                ease: "power2.out"
            });
        }

        function addToWishlist(productId) {
            if (!productId) {
                Swal.fire({
                    title: 'Invalid Product',
                    text: 'Invalid product ID. Please try again.',
                    icon: 'error'
                });
                return;
            }

            $.ajax({
                url: '/addToWishlist',
                method: 'patch',
                contentType: 'application/json',
                data: JSON.stringify({ productId }),
                success: (response) => {
                    if (response.status) {
                        const btn = document.getElementById('wishlistBtn');
                        btn.classList.add('in-wishlist');
                        btn.querySelector('i').classList.replace('far', 'fas');

                        Swal.fire({
                            title: 'Added to Wishlist',
                            text: 'The product has been added to your wishlist!',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false,
                            timerProgressBar: true
                        });
                    } else if (response.message === "Product already in wishlist") {
                        Swal.fire({
                            title: 'In Wishlist',
                            text: 'This product is already in your wishlist. Would you like to view it or remove it?',
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'View Wishlist',
                            cancelButtonText: 'Remove Item',
                            showDenyButton: true,
                            denyButtonText: 'Continue Shopping'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/wishlist';
                            } else if (result.dismiss === Swal.DismissReason.cancel) {
                                // Optional: Implement direct remove from here if desired
                                removeFromWishlist(productId);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Login Required',
                            text: 'Please log in to add items to your wishlist.',
                            icon: 'warning',
                            confirmButtonText: 'Log In'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                    }
                },
                error: (xhr) => {
                    const errorMessage = xhr.responseJSON?.message || "There was an error adding to wishlist.";
                    Swal.fire({ title: 'Error', text: errorMessage, icon: 'error' });
                }
            });
        }

        function removeFromWishlist(productId) {
            $.ajax({
                url: `/removeFromWishList?productId=${productId}`,
                method: 'DELETE',
                success: (response) => {
                    if (response.success) {
                        const btn = document.getElementById('wishlistBtn');
                        btn.classList.remove('in-wishlist');
                        btn.querySelector('i').classList.replace('fas', 'far');

                        Swal.fire({
                            title: 'Removed!',
                            text: 'Item removed from wishlist',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function addToCart(productId) {
            fetch('/add-cart', {
                method: 'post',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => { throw new Error(data.message || 'Something went wrong'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Product added to cart',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'Go to Cart',
                            cancelButtonText: 'Continue Shopping'
                        }).then((result) => {
                            if (result.isConfirmed) window.location.href = '/cart';
                        });
                    } else if (data.error === "max_limit") {
                        Swal.fire({ title: 'Limit Reached', text: 'Max 5 per product allowed.', icon: 'warning' });
                    } else if (data.error === "out_of_stock") {
                        Swal.fire({ title: 'Out of Stock', text: 'Not enough stock available.', icon: 'error' });
                    }
                })
                .catch(error => {
                    if (error.message === "User not logged in") {
                        Swal.fire({
                            title: 'Login Required',
                            text: 'Please log in to add items to your cart.',
                            icon: 'warning',
                            confirmButtonText: 'Log In',
                        }).then((result) => {
                            if (result.isConfirmed) window.location.href = '/login';
                        });
                    } else {
                        Swal.fire({ title: 'Error', text: error.message, icon: 'error' });
                    }
                });
        }
    </script>

    <%- include('../partials/user/footer') %>